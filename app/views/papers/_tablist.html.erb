<%
  paper = reference.paper
  comments_count = reference.comments.map {|c| c.self_and_descendants.length}.inject(0,&:+)
  display_count = if comments_count.zero? then "" else "(#{comments_count})" end
%>

<ul class="nav nav-pills small" role="tablist">
  <% %i{abstract details}.each do |tab| %>
    <li><%= link_to tab.capitalize, '', "data-detail-id" => "#{tab}-#{tab_id_for(paper)}", class: "paper-detail-tab" %></li>
  <% end %>
  <li><%= link_to "Comments#{display_count}", '', "data-detail-id" => "comments-#{tab_id_for(paper)}", class: " paper-detail-tab" %></li>
  <% if current_user %>
    <li>
      <%= form_for reference, method: :delete do |r| %>
        <%= r.text_field :id, value: reference.id, hidden: true %>
      <% end %>
      <%= link_to 'Remove from list', {}, class: 'delete-reference text-danger' %>
    </li>
  <% end %>
</ul>
<div class="collapse paper-detail well" id="abstract-<%= tab_id_for(paper) %>">
  <p><%= paper.abstract %></p>
</div>
<div class="collapse paper-detail well" id="details-<%= tab_id_for(paper) %>">
  <ul>
    <li>Published: <%= paper.published_at %></li>
    <li>DOI: <%= paper.doi %></li>
    <li>Pubmed ID: <%= paper.pubmed_id %></li>
    <li>
      Link:
      <% if paper.links.length > 1 %>
        <ul>
          <% paper.links.each do |l| %>
            <li><%= l.link %></li>
          <% end %>
        </ul>
      <% else %>
        <%= paper.links.first.link if paper.links.present? %>
      <% end %>
    </li>
  </ul>
</div>
<div class="paper-detail well collapse <%= "in" if show_comments %>" id="comments-<%= tab_id_for(paper) %>">
  <% if current_user %>
    <%= render('comments/form', comment: reference.comments.build, display_comment_field: true) %>
  <% else %>
    <h4>
      <%= link_to 'Sign in', new_user_session_path %> or <%= link_to 'Sign up', new_user_registration_path %> to comment
    </h4>
  <% end %>
  <% reference.comments.order('cached_votes_up DESC, created_at ASC').each do |comment| %>
      <%= comments_tree_for comment.hash_tree %>
  <% end %>
</div>
